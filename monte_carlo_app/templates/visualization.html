{% extends 'monte_carlo_app/base.html' %}
{% load static %}

{% block title %}Visualizations - {{ session.file_name }}{% endblock %}

{% block breadcrumb %}
{{ block.super }}
<li class="breadcrumb-item">
    <a href="{% url 'monte_carlo_app:home' %}" class="text-decoration-none">Upload</a>
</li>
<li class="breadcrumb-item">
    <a href="{% url 'monte_carlo_app:preview_data' session.session_id %}" class="text-decoration-none">Preview</a>
</li>
<li class="breadcrumb-item">
    <a href="{% url 'monte_carlo_app:view_results' session.session_id %}" class="text-decoration-none">Results</a>
</li>
<li class="breadcrumb-item active">Visualizations</li>
{% endblock %}

{% block extra_head %}
<style>
    .viz-header {
        background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .viz-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M20 20c0-5.5-4.5-10-10-10s-10 4.5-10 10 4.5 10 10 10 10-4.5 10-10zm10 0c0-5.5-4.5-10-10-10s-10 4.5-10 10 4.5 10 10 10 10-4.5 10-10z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
        animation: float 25s infinite linear;
        z-index: 1;
    }
    
    .viz-content {
        position: relative;
        z-index: 2;
    }
    
    .chart-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    .chart-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .chart-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    }
    
    .chart-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .chart-title {
        font-weight: 600;
        color: #495057;
        margin: 0;
        flex: 1;
    }
    
    .chart-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .chart-action-btn {
        background: none;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 0.25rem 0.5rem;
        color: #6c757d;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .chart-action-btn:hover {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .chart-body {
        padding: 1.5rem;
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .chart-container {
        width: 100%;
        height: 300px;
        position: relative;
    }
    
    .chart-description {
        padding: 1rem 1.5rem;
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .chart-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
        color: #6c757d;
    }
    
    .chart-loading .spinner-border {
        margin-bottom: 1rem;
    }
    
    .viz-controls {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 2rem;
        position: sticky;
        top: 90px;
        z-index: 100;
    }
    
    .control-group {
        margin-bottom: 1rem;
    }
    
    .control-group:last-child {
        margin-bottom: 0;
    }
    
    .control-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .column-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .column-chip {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 20px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        position: relative;
    }
    
    .column-chip:hover {
        border-color: #007bff;
        background: #e3f2fd;
    }
    
    .column-chip.selected {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .column-chip.numeric {
        border-color: #28a745;
    }
    
    .column-chip.numeric.selected {
        background: #28a745;
        border-color: #28a745;
    }
    
    .chart-type-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
    }
    
    .chart-type-card {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .chart-type-card:hover {
        border-color: #007bff;
        background: #e3f2fd;
    }
    
    .chart-type-card.selected {
        border-color: #007bff;
        background: #007bff;
        color: white;
    }
    
    .chart-type-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        color: #6c757d;
    }
    
    .chart-type-card.selected .chart-type-icon {
        color: white;
    }
    
    .insights-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .insight-item {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #2196f3;
        position: relative;
    }
    
    .insight-item.success {
        background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
        border-left-color: #4caf50;
    }
    
    .insight-item.warning {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        border-left-color: #ff9800;
    }
    
    .insight-icon {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.2rem;
        opacity: 0.7;
    }
    
    .fullscreen-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
    }
    
    .fullscreen-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        max-width: 95vw;
        max-height: 95vh;
        overflow: auto;
        position: relative;
    }
    
    .fullscreen-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }
    
    .export-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .comparison-slider {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .slider-container {
        position: relative;
        margin: 1rem 0;
    }
    
    .before-after-slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #dee2e6;
        outline: none;
        transition: all 0.3s ease;
    }
    
    .before-after-slider::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #007bff;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .slider-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    @keyframes float {
        0% { transform: translate(0, 0); }
        100% { transform: translate(-40px, -40px); }
    }
    
    @media (max-width: 768px) {
        .viz-header {
            padding: 1rem;
        }
        
        .chart-gallery {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .viz-controls {
            position: relative;
            top: auto;
        }
        
        .chart-type-selector {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .column-selector {
            justify-content: center;
        }
    }
    
    .chart-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
        color: #dc3545;
        text-align: center;
    }
    
    .chart-error i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<!-- Visualization Header -->
<div class="viz-header">
    <div class="viz-content">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-1">
                    <i class="bi bi-graph-up-arrow me-2"></i>
                    Data Visualizations
                </h2>
                <p class="mb-0">Interactive charts and insights from your imputed dataset</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-flex justify-content-end align-items-center gap-3">
                    <div class="text-center">
                        <div class="h4 mb-0">{{ visualizations|length }}</div>
                        <small>Charts Generated</small>
                    </div>
                    <div class="text-center">
                        <div class="h4 mb-0">{{ session.get_numeric_columns|length }}</div>
                        <small>Data Columns</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Visualization Controls -->
<div class="viz-controls">
    <div class="row">
        <div class="col-md-3">
            <div class="control-group">
                <label class="control-label">
                    <i class="bi bi-sliders me-1"></i>
                    Chart Type
                </label>
                <div class="chart-type-selector">
                    <div class="chart-type-card selected" data-type="all">
                        <i class="bi bi-grid chart-type-icon"></i>
                        <div class="small">All Charts</div>
                    </div>
                    <div class="chart-type-card" data-type="distribution">
                        <i class="bi bi-bar-chart chart-type-icon"></i>
                        <div class="small">Distribution</div>
                    </div>
                    <div class="chart-type-card" data-type="comparison">
                        <i class="bi bi-arrows-expand chart-type-icon"></i>
                        <div class="small">Comparison</div>
                    </div>
                    <div class="chart-type-card" data-type="quality">
                        <i class="bi bi-shield-check chart-type-icon"></i>
                        <div class="small">Quality</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="control-group">
                <label class="control-label">
                    <i class="bi bi-columns me-1"></i>
                    Select Columns
                </label>
                <div class="column-selector">
                    {% for column in session.get_column_names %}
                    <div class="column-chip {% if column in session.get_numeric_columns %}numeric{% endif %} selected" 
                         data-column="{{ column }}">
                        {{ column }}
                        {% if column in session.get_numeric_columns %}
                            <i class="bi bi-123 ms-1"></i>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="control-group">
                <label class="control-label">
                    <i class="bi bi-gear me-1"></i>
                    Actions
                </label>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshCharts()">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Refresh
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="exportAllCharts()">
                        <i class="bi bi-download me-1"></i>
                        Export All
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Before/After Comparison Slider -->
<div class="comparison-slider">
    <h5 class="mb-3">
        <i class="bi bi-arrows-expand text-primary me-2"></i>
        Before vs After Comparison
    </h5>
    <div class="slider-container">
        <input type="range" class="before-after-slider" id="comparisonSlider" 
               min="0" max="100" value="50">
        <div class="slider-labels">
            <span><i class="bi bi-exclamation-triangle text-warning"></i> Before Imputation</span>
            <span><i class="bi bi-check-circle text-success"></i> After Imputation</span>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-6">
            <div class="text-center p-3 bg-light rounded">
                <h6 class="text-warning">Original Data</h6>
                <div class="h4">{{ session.get_total_missing_values }}</div>
                <small>Missing Values</small>
            </div>
        </div>
        <div class="col-md-6">
            <div class="text-center p-3 bg-light rounded">
                <h6 class="text-success">Imputed Data</h6>
                <div class="h4">0</div>
                <small>Missing Values</small>
            </div>
        </div>
    </div>
</div>

<!-- AI Insights Panel -->
<div class="insights-panel">
    <h5 class="text-primary mb-3">
        <i class="bi bi-lightbulb me-2"></i>
        AI-Generated Insights
    </h5>
    
    <div class="insight-item success">
        <i class="bi bi-check-circle insight-icon"></i>
        <h6>High Quality Imputation</h6>
        <p class="mb-0">The Monte Carlo simulation achieved a quality score of {{ session.result.imputation_quality_score|floatformat:3 }}, indicating reliable imputation results across all numeric columns.</p>
    </div>
    
    <div class="insight-item">
        <i class="bi bi-graph-up insight-icon"></i>
        <h6>Pattern Preservation</h6>
        <p class="mb-0">Statistical analysis shows that the imputed values maintain the original data distribution patterns, ensuring analytical integrity.</p>
    </div>
    
    {% if session.time_column %}
    <div class="insight-item success">
        <i class="bi bi-clock-history insight-icon"></i>
        <h6>Temporal Consistency</h6>
        <p class="mb-0">Time-series patterns were successfully preserved in the imputed values, maintaining temporal relationships in the {{ session.time_column }} column.</p>
    </div>
    {% endif %}
    
    <div class="insight-item warning">
        <i class="bi bi-info-circle insight-icon"></i>
        <h6>Recommendation</h6>
        <p class="mb-0">For future datasets, consider collecting more frequent observations to reduce missing value gaps and improve imputation accuracy.</p>
    </div>
</div>

<!-- Chart Gallery -->
<div class="chart-gallery" id="chartGallery">
    {% for viz in visualizations %}
    <div class="chart-card" data-chart-type="{{ viz.type }}">
        <div class="chart-header">
            <h6 class="chart-title">
                <i class="bi bi-{{ viz.type|default:'graph-up' }} me-2"></i>
                {{ viz.title }}
            </h6>
            <div class="chart-actions">
                <button class="chart-action-btn" onclick="expandChart(this)" title="Fullscreen">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
                <button class="chart-action-btn" onclick="downloadChart(this)" title="Download">
                    <i class="bi bi-download"></i>
                </button>
                <button class="chart-action-btn" onclick="shareChart(this)" title="Share">
                    <i class="bi bi-share"></i>
                </button>
            </div>
        </div>
        
        <div class="chart-body">
            {% if viz.image %}
                <img src="data:image/png;base64,{{ viz.image }}" 
                     alt="{{ viz.title }}" 
                     class="img-fluid"
                     style="max-width: 100%; height: auto;">
            {% else %}
                <div class="chart-container" id="chart-{{ forloop.counter }}">
                    <div class="chart-loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>Generating {{ viz.title|lower }}...</div>
                    </div>
                </div>
            {% endif %}
        </div>
        
        <div class="chart-description">
            {{ viz.description }}
        </div>
    </div>
    {% empty %}
    <!-- No visualizations available -->
    <div class="col-12">
        <div class="chart-card">
            <div class="chart-body">
                <div class="chart-error">
                    <i class="bi bi-exclamation-triangle"></i>
                    <h5>No Visualizations Available</h5>
                    <p class="text-muted">Visualizations could not be generated for this dataset.</p>
                    <button class="btn btn-primary" onclick="generateVisualizations()">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Try Generate Again
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Custom Chart Creation -->
<div class="viz-controls">
    <h5 class="text-primary mb-3">
        <i class="bi bi-plus-circle me-2"></i>
        Create Custom Chart
    </h5>
    
    <div class="row">
        <div class="col-md-4">
            <label class="control-label">Chart Type</label>
            <select class="form-select" id="customChartType">
                <option value="line">Line Chart</option>
                <option value="bar">Bar Chart</option>
                <option value="scatter">Scatter Plot</option>
                <option value="histogram">Histogram</option>
                <option value="box">Box Plot</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="control-label">X-Axis Column</label>
            <select class="form-select" id="customXAxis">
                {% for column in session.get_column_names %}
                <option value="{{ column }}">{{ column }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label class="control-label">Y-Axis Column</label>
            <select class="form-select" id="customYAxis">
                {% for column in session.get_numeric_columns %}
                <option value="{{ column }}">{{ column }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    
    <div class="mt-3">
        <button class="btn btn-primary" onclick="createCustomChart()">
            <i class="bi bi-plus-circle me-1"></i>
            Create Chart
        </button>
        <button class="btn btn-outline-secondary ms-2" onclick="resetCustomChart()">
            <i class="bi bi-arrow-counterclockwise me-1"></i>
            Reset
        </button>
    </div>
</div>

<!-- Action Buttons -->
<div class="d-flex justify-content-between align-items-center mt-4">
    <div>
        <a href="{% url 'monte_carlo_app:view_results' session.session_id %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>
            Back to Results
        </a>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="generateReport()">
            <i class="bi bi-file-earmark-pdf me-1"></i>
            Generate Report
        </button>
        <a href="{% url 'monte_carlo_app:export_results' session.session_id %}" class="btn btn-success">
            <i class="bi bi-download me-1"></i>
            Export Data
        </a>
    </div>
</div>

<!-- Fullscreen Modal -->
<div class="fullscreen-modal" id="fullscreenModal">
    <div class="fullscreen-content">
        <button class="fullscreen-close" onclick="closeFullscreen()">
            <i class="bi bi-x"></i>
        </button>
        <div id="fullscreenChart"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedColumns = {{ session.get_column_names|safe }};
    let selectedChartType = 'all';
    
    // Initialize components
    initializeControls();
    initializeCharts();
    initializeComparisonSlider();
    
    function initializeControls() {
        // Chart type selector
        const chartTypeCards = document.querySelectorAll('.chart-type-card');
        chartTypeCards.forEach(card => {
            card.addEventListener('click', function() {
                chartTypeCards.forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedChartType = this.dataset.type;
                filterCharts();
            });
        });
        
        // Column selector
        const columnChips = document.querySelectorAll('.column-chip');
        columnChips.forEach(chip => {
            chip.addEventListener('click', function() {
                this.classList.toggle('selected');
                updateSelectedColumns();
                updateCharts();
            });
        });
    }
    
    function updateSelectedColumns() {
        selectedColumns = [];
        document.querySelectorAll('.column-chip.selected').forEach(chip => {
            selectedColumns.push(chip.dataset.column);
        });
    }
    
    function filterCharts() {
        const charts = document.querySelectorAll('.chart-card');
        charts.forEach(chart => {
            const chartType = chart.dataset.chartType;
            
            if (selectedChartType === 'all' || chartType === selectedChartType) {
                chart.style.display = 'block';
                // Add animation
                chart.style.animation = 'fadeIn 0.3s ease-in';
            } else {
                chart.style.display = 'none';
            }
        });
    }
    
    function initializeCharts() {
        // Load charts with delay for smooth animation
        const chartContainers = document.querySelectorAll('.chart-container');
        chartContainers.forEach((container, index) => {
            setTimeout(() => {
                loadChart(container, index);
            }, index * 500);
        });
    }
    
    function loadChart(container, index) {
        // Simulate chart loading
        setTimeout(() => {
            const loading = container.querySelector('.chart-loading');
            if (loading) {
                // Replace loading with actual chart
                container.innerHTML = createSampleChart(index);
            }
        }, 1000 + Math.random() * 1000);
    }
    
    function createSampleChart(index) {
        const chartTypes = ['line', 'bar', 'scatter', 'area'];
        const chartType = chartTypes[index % chartTypes.length];
        
        return `
            <canvas id="chart-canvas-${index}" width="100%" height="300"></canvas>
            <script>
                // Chart.js implementation would go here
                console.log('Chart ${index} loaded');
            </script>
        `;
    }
    
    function initializeComparisonSlider() {
        const slider = document.getElementById('comparisonSlider');
        if (slider) {
            slider.addEventListener('input', function() {
                const value = this.value;
                updateComparisonView(value);
            });
        }
    }
    
    function updateComparisonView(sliderValue) {
        // Update visualization based on slider value
        const charts = document.querySelectorAll('.chart-card[data-chart-type="comparison"]');
        charts.forEach(chart => {
            // Apply visual transformation based on slider value
            const opacity = sliderValue / 100;
            chart.style.setProperty('--comparison-opacity', opacity);
        });
    }
    
    // Global functions
    window.expandChart = function(button) {
        const chartCard = button.closest('.chart-card');
        const chartContent = chartCard.querySelector('.chart-body').innerHTML;
        const chartTitle = chartCard.querySelector('.chart-title').textContent;
        
        const fullscreenModal = document.getElementById('fullscreenModal');
        const fullscreenChart = document.getElementById('fullscreenChart');
        
        fullscreenChart.innerHTML = `
            <h3 class="mb-3">${chartTitle}</h3>
            <div style="height: 70vh;">${chartContent}</div>
        `;
        
        fullscreenModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    };
    
    window.closeFullscreen = function() {
        const fullscreenModal = document.getElementById('fullscreenModal');
        fullscreenModal.style.display = 'none';
        document.body.style.overflow = 'auto';
    };
    
    window.downloadChart = function(button) {
        const chartCard = button.closest('.chart-card');
        const chartTitle = chartCard.querySelector('.chart-title').textContent;
        const chartImage = chartCard.querySelector('img');
        
        if (chartImage) {
            // Download existing image
            const link = document.createElement('a');
            link.href = chartImage.src;
            link.download = `${chartTitle.replace(/\s+/g, '_').toLowerCase()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Chart downloaded successfully!', 'success');
        } else {
            // Generate and download chart
            generateChartImage(chartCard).then(dataUrl => {
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = `${chartTitle.replace(/\s+/g, '_').toLowerCase()}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Chart downloaded successfully!', 'success');
            }).catch(error => {
                showToast('Failed to download chart', 'error');
            });
        }
    };
    
    window.shareChart = function(button) {
        const chartCard = button.closest('.chart-card');
        const chartTitle = chartCard.querySelector('.chart-title').textContent;
        const chartDescription = chartCard.querySelector('.chart-description').textContent;
        
        const shareData = {
            title: `Monte Carlo Visualization: ${chartTitle}`,
            text: chartDescription,
            url: window.location.href
        };
        
        if (navigator.share) {
            navigator.share(shareData).then(() => {
                showToast('Chart shared successfully!', 'success');
            }).catch(() => {
                fallbackShare(shareData);
            });
        } else {
            fallbackShare(shareData);
        }
    };
    
    function fallbackShare(shareData) {
        const textToCopy = `${shareData.title}\n${shareData.text}\n${shareData.url}`;
        navigator.clipboard.writeText(textToCopy).then(() => {
            showToast('Chart information copied to clipboard!', 'success');
        }).catch(() => {
            showToast('Unable to share chart', 'error');
        });
    }
    
    window.refreshCharts = function() {
        showLoading();
        
        // Reset all charts to loading state
        const chartContainers = document.querySelectorAll('.chart-container');
        chartContainers.forEach(container => {
            container.innerHTML = `
                <div class="chart-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div>Regenerating chart...</div>
                </div>
            `;
        });
        
        // Reload charts
        setTimeout(() => {
            initializeCharts();
            hideLoading();
            showToast('Charts refreshed successfully!', 'success');
        }, 2000);
    };
    
    window.exportAllCharts = function() {
        showLoading();
        
        const charts = document.querySelectorAll('.chart-card');
        const exportPromises = [];
        
        charts.forEach((chart, index) => {
            const promise = generateChartImage(chart).then(dataUrl => {
                return {
                    title: chart.querySelector('.chart-title').textContent,
                    dataUrl: dataUrl
                };
            });
            exportPromises.push(promise);
        });
        
        Promise.all(exportPromises).then(chartData => {
            // Create ZIP file with all charts
            createChartZip(chartData);
            hideLoading();
            showToast('All charts exported successfully!', 'success');
        }).catch(error => {
            hideLoading();
            showToast('Failed to export charts', 'error');
        });
    };
    
    function generateChartImage(chartCard) {
        return new Promise((resolve, reject) => {
            // Use html2canvas or similar library to convert chart to image
            // For now, simulate with timeout
            setTimeout(() => {
                // Create a simple colored rectangle as placeholder
                const canvas = document.createElement('canvas');
                canvas.width = 800;
                canvas.height = 400;
                const ctx = canvas.getContext('2d');
                
                // Random color
                const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8'];
                ctx.fillStyle = colors[Math.floor(Math.random() * colors.length)];
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Add title
                ctx.fillStyle = 'white';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(chartCard.querySelector('.chart-title').textContent, canvas.width/2, canvas.height/2);
                
                resolve(canvas.toDataURL());
            }, 500);
        });
    }
    
    function createChartZip(chartData) {
        // Simulate ZIP creation
        const zipContent = chartData.map(chart => `${chart.title}: ${chart.dataUrl.substring(0, 50)}...`).join('\n');
        
        const blob = new Blob([zipContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'monte_carlo_charts.txt';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
    }
    
    window.updateCharts = function() {
        // Filter charts based on selected columns
        const charts = document.querySelectorAll('.chart-card');
        charts.forEach(chart => {
            const chartTitle = chart.querySelector('.chart-title').textContent.toLowerCase();
            const shouldShow = selectedColumns.some(col => 
                chartTitle.includes(col.toLowerCase()) || selectedColumns.length === 0
            );
            
            chart.style.display = shouldShow ? 'block' : 'none';
        });
    };
    
    window.generateVisualizations = function() {
        showLoading();
        
        // Make AJAX request to generate visualizations
        fetch(`{% url 'monte_carlo_app:visualization' session.session_id %}?regenerate=true`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                columns: selectedColumns,
                chart_types: [selectedChartType]
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                showToast('Failed to generate visualizations', 'error');
            }
        })
        .catch(error => {
            showToast('Error generating visualizations', 'error');
        })
        .finally(() => {
            hideLoading();
        });
    };
    
    window.createCustomChart = function() {
        const chartType = document.getElementById('customChartType').value;
        const xAxis = document.getElementById('customXAxis').value;
        const yAxis = document.getElementById('customYAxis').value;
        
        if (!xAxis || !yAxis) {
            showToast('Please select both X and Y axis columns', 'error');
            return;
        }
        
        showLoading();
        
        // Create new chart card
        const chartGallery = document.getElementById('chartGallery');
        const newChartHtml = `
            <div class="chart-card" data-chart-type="custom">
                <div class="chart-header">
                    <h6 class="chart-title">
                        <i class="bi bi-graph-up me-2"></i>
                        Custom ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Chart: ${yAxis} vs ${xAxis}
                    </h6>
                    <div class="chart-actions">
                        <button class="chart-action-btn" onclick="expandChart(this)" title="Fullscreen">
                            <i class="bi bi-arrows-fullscreen"></i>
                        </button>
                        <button class="chart-action-btn" onclick="downloadChart(this)" title="Download">
                            <i class="bi bi-download"></i>
                        </button>
                        <button class="chart-action-btn" onclick="removeChart(this)" title="Remove">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-body">
                    <div class="chart-container">
                        <div class="chart-loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div>Creating custom chart...</div>
                        </div>
                    </div>
                </div>
                <div class="chart-description">
                    Custom ${chartType} chart showing the relationship between ${xAxis} and ${yAxis}.
                </div>
            </div>
        `;
        
        chartGallery.insertAdjacentHTML('beforeend', newChartHtml);
        
        // Simulate chart creation
        setTimeout(() => {
            const newChart = chartGallery.lastElementChild;
            const container = newChart.querySelector('.chart-container');
            container.innerHTML = createCustomChartContent(chartType, xAxis, yAxis);
            hideLoading();
            showToast('Custom chart created successfully!', 'success');
            
            // Scroll to new chart
            newChart.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 2000);
    };
    
    function createCustomChartContent(chartType, xAxis, yAxis) {
        // Create placeholder chart content
        const canvas = document.createElement('canvas');
        canvas.width = 400;
        canvas.height = 300;
        canvas.style.width = '100%';
        canvas.style.height = '300px';
        
        const ctx = canvas.getContext('2d');
        
        // Draw simple chart based on type
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.strokeStyle = '#007bff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        if (chartType === 'line') {
            // Draw line chart
            for (let i = 0; i < canvas.width; i += 10) {
                const y = canvas.height/2 + Math.sin(i/50) * 50;
                if (i === 0) ctx.moveTo(i, y);
                else ctx.lineTo(i, y);
            }
        } else if (chartType === 'bar') {
            // Draw bar chart
            for (let i = 0; i < 10; i++) {
                const x = i * 40;
                const height = Math.random() * 200 + 50;
                ctx.fillStyle = '#007bff';
                ctx.fillRect(x, canvas.height - height, 30, height);
            }
        }
        
        ctx.stroke();
        
        // Add labels
        ctx.fillStyle = '#495057';
        ctx.font = '12px Arial';
        ctx.fillText(xAxis, canvas.width/2, canvas.height - 10);
        
        ctx.save();
        ctx.translate(15, canvas.height/2);
        ctx.rotate(-Math.PI/2);
        ctx.fillText(yAxis, 0, 0);
        ctx.restore();
        
        return canvas.outerHTML;
    }
    
    window.resetCustomChart = function() {
        document.getElementById('customChartType').value = 'line';
        document.getElementById('customXAxis').selectedIndex = 0;
        document.getElementById('customYAxis').selectedIndex = 0;
    };
    
    window.removeChart = function(button) {
        if (confirm('Are you sure you want to remove this chart?')) {
            const chartCard = button.closest('.chart-card');
            chartCard.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                chartCard.remove();
                showToast('Chart removed successfully!', 'success');
            }, 300);
        }
    };
    
    window.generateReport = function() {
        showLoading();
        
        // Simulate report generation
        setTimeout(() => {
            hideLoading();
            
            const reportContent = `
                Monte Carlo Imputation Report
                ===========================
                
                File: {{ session.file_name }}
                Processing Date: {{ session.result.created_at|date:"Y-m-d H:i" }}
                
                Summary:
                - Total Rows: {{ session.total_rows }}
                - Imputed Values: {{ session.result.imputed_values_count }}
                - Quality Score: {{ session.result.imputation_quality_score|floatformat:3 }}
                - Processing Time: {{ session.result.processing_time|floatformat:2 }}s
                
                Visualizations Generated: ${document.querySelectorAll('.chart-card').length}
                
                Generated on: ${new Date().toISOString()}
            `;
            
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'monte_carlo_report.txt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            showToast('Report generated and downloaded!', 'success');
        }, 2000);
    };
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('fullscreenModal').style.display === 'flex') {
            closeFullscreen();
        } else if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'r':
                    e.preventDefault();
                    refreshCharts();
                    break;
                case 'd':
                    e.preventDefault();
                    exportAllCharts();
                    break;
            }
        }
    });
    
    // Add CSS for animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }
        
        .chart-card {
            transition: all 0.3s ease;
        }
    `;
    document.head.appendChild(style);
    
    // Initialize intersection observer for lazy loading
    const chartObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const chartCard = entry.target;
                const loading = chartCard.querySelector('.chart-loading');
                if (loading) {
                    // Trigger chart loading when visible
                    const container = chartCard.querySelector('.chart-container');
                    setTimeout(() => {
                        loadChart(container, Math.floor(Math.random() * 4));
                    }, Math.random() * 1000);
                }
                chartObserver.unobserve(chartCard);
            }
        });
    });
    
    document.querySelectorAll('.chart-card').forEach(card => {
        chartObserver.observe(card);
    });
});
</script>
{% endblock %}